{{- $documents := slice -}}
{{- $url := chomp ( partial "meilindex/fields/url" . ) -}}
{{- $site := .Site.Params.site -}}
{{- $rank := .Site.Params.rank -}}
{{- $rootURL := .Site.Params.rooturl -}}
{{- $section := chomp ( partial "meilindex/fields/section" . ) -}}
{{- $subections := "" -}}
{{- $splitContent := split .Content "\n" -}}
{{- $runningText := chomp ( partial "meilindex/fields/text" . ) -}}
{{- $currentHeadingTitle := .Title -}}
{{- $pageTitle := .Title -}}
{{- $currentHeadingAnchor := "" -}}
{{- $count := 0 -}}
{{- range $splitContent -}}
    {{- $count = add $count 1 -}}
    {{- $checkHeaderPresent := split . "<h" -}}
      {{- $line := split  . "id=\"" -}}
      {{- if and ( gt ( len $line ) 1 ) ( gt ( len $checkHeaderPresent ) 1  ) -}}
        {{- $finalRelURL := "" -}}
        {{- if eq ( len $currentHeadingAnchor ) 0 -}}
          {{- $finalRelURL = $url -}}
        {{- else -}}
          {{- $finalRelURL = printf "%s#%s" $url $currentHeadingAnchor -}}
        {{- end -}}
        {{- $finalFullURL := $finalRelURL -}}
        {{- $documentId := sha1 $finalFullURL -}}
        {{- if ne $currentHeadingTitle $pageTitle -}}
          {{- $section = $pageTitle -}}
        {{- end -}}
        {{- $runningText = replace $runningText "\n" " " -}}
        {{- $documents = $documents | append ( dict "title" $currentHeadingTitle "site" $site "rank" $rank "relurl" $finalRelURL "url" $finalFullURL "text" ( $runningText | plainify | safeHTML ) "documentId" $documentId "section" $section ) -}}
        {{- $runningText = "" -}}
        {{- $currentHeadingAnchor = . |  plainify | anchorize -}}
        {{- $currentHeadingTitle = . | plainify -}}
      {{- else if eq $count (len $splitContent) -}}
        {{- $finalRelURL := "" -}}
        {{- if eq ( len $currentHeadingAnchor ) 0 -}}
          {{- $finalRelURL = $url -}}
        {{- else -}}
          {{- $finalRelURL = printf "%s#%s" $url $currentHeadingAnchor -}}
        {{- end -}}
        {{- $finalFullURL := $finalRelURL -}}
        {{- $documentId := sha1 $finalFullURL -}}
        {{- if ne $currentHeadingTitle $pageTitle -}}
          {{- $section = $pageTitle -}}
        {{- end -}}
        {{- $runningText = replace $runningText "\n" " " -}}
        {{- $documents = $documents | append ( dict "title" $currentHeadingTitle "site" $site "rank" $rank "relurl" $finalRelURL "url" $finalFullURL "text" ( $runningText | plainify | safeHTML ) "documentId" $documentId "section" $section ) -}}
      {{- else -}}
        {{- $runningText = printf "%s %s" $runningText . -}}
      {{- end -}}
{{- end -}}
{{- $documents | jsonify -}}
